# -*- coding: utf-8 -*-
# MR.CHAâ”‚ì‚¼ì„±C&T HVDC í”„ë¡œì íŠ¸í˜• ì‹¤ë¬´ ëŒ€ì‹œë³´ë“œ

from taipy.gui import Gui
import pandas as pd
import datetime
import os

# 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì „ì²˜ë¦¬
def load_hvdc_data():
    """HVDC ë°ì´í„° ë¡œë”© - ì—¬ëŸ¬ ì†ŒìŠ¤ ì‹œë„"""
    data_sources = [
        "data/HVDC PKGS.xlsx",
        "data/hvdc_logistics.csv", 
        "HVDC_PJT/data/HVDC PKGS.xlsx",
        "HVDC_PJT/data/hvdc_logistics.csv"
    ]
    
    for source in data_sources:
        try:
            if source.endswith('.xlsx'):
                df = pd.read_excel(source, sheet_name="LSR")
                print(f"âœ… Excel íŒŒì¼ ë¡œë“œ ì„±ê³µ: {source}")
                return process_excel_data(df)
            elif source.endswith('.csv'):
                df = pd.read_csv(source, parse_dates=["ì…ê³ ì¼"], dayfirst=True)
                print(f"âœ… CSV íŒŒì¼ ë¡œë“œ ì„±ê³µ: {source}")
                return process_csv_data(df)
        except Exception as e:
            print(f"âŒ {source} ë¡œë“œ ì‹¤íŒ¨: {e}")
            continue
    
    # ìƒ˜í”Œ ë°ì´í„° ìƒì„± (ì‹¤ì œ ë°ì´í„° ì—†ì„ ê²½ìš°)
    print("âš ï¸ ì‹¤ì œ ë°ì´í„° ì—†ìŒ - ìƒ˜í”Œ ë°ì´í„° ìƒì„±")
    return create_sample_data()

def process_excel_data(df):
    """Excel ë°ì´í„° ì „ì²˜ë¦¬"""
    # TEU ì‚°ì • í•¨ìˆ˜
    def calc_teu(row):
        teu = 0
        teu += row.get('20DC', 0) * 1
        teu += row.get('40DC', 0) * 2
        teu += row.get('40HQ', 0) * 2
        teu += row.get('40FR(IN)', 0) * 2
        return teu

    # ì»¨í…Œì´ë„ˆ ì»¬ëŸ¼ ìˆ«ì ë³€í™˜
    for col in ['20DC', '40DC', '40HQ', '40FR(IN)']:
        if col in df.columns:
            df[col] = pd.to_numeric(df.get(col, 0), errors='coerce').fillna(0)

    df['TEU'] = df.apply(calc_teu, axis=1)

    # OOG êµ¬ë¶„
    def is_oog(row):
        txt = str(row.get('SHIP\n MODE', '')).upper() + str(row.get('MAIN DESCRIPTION (PO)', '')).upper()
        return any(key in txt for key in ['OOG', 'FR', 'OT'])

    df['OOG'] = df.apply(is_oog, axis=1)

    # ì—°ì›” í•„ë“œ ìƒì„±
    if 'Status_Location_Date_Year' in df.columns:
        df['YEAR'] = df['Status_Location_Date_Year'].astype('Int64').fillna(0)
        df['MONTH'] = df['Status_Location_Date_Month'].astype('Int64').fillna(0)
        df['YYYYMM'] = df['YEAR'].astype(str) + '-' + df['MONTH'].astype(str).str.zfill(2)
    else:
        df['YEAR'] = 2024
        df['MONTH'] = 1
        df['YYYYMM'] = '2024-01'

    # ì°½ê³  êµ¬ë¶„
    warehouse_cols = ['DSV Indoor', 'DSV Outdoor', 'AAA Storage']
    def get_warehouse(row):
        for wh in warehouse_cols:
            if wh in df.columns and pd.notnull(row.get(wh)) and row[wh] == 1:
                return wh
        return 'ê¸°íƒ€'
    
    df['WAREHOUSE'] = df.apply(get_warehouse, axis=1)
    
    return df

def process_csv_data(df):
    """CSV ë°ì´í„° ì „ì²˜ë¦¬"""
    # HS Code ë§¤í•‘
    if "HS Code" not in df.columns:
        df["HS Code"] = df["ì¹´í…Œê³ ë¦¬"].map({
            "ì „ì": "8471", "ì‚¬ë¬´": "9403", "OOG": "8905"
        }).fillna("ê¸°íƒ€")
    
    # OOG êµ¬ë¶„
    if "OOG" not in df.columns:
        df["OOG"] = df["ìƒí’ˆëª…"].str.contains("íŠ¸ëœìŠ¤í¬ë¨¸|ì¤‘ëŸ‰ë¬¼").map({True: "OOG", False: "ì¼ë°˜"})
    
    # DEM/DET ê³„ì‚°
    if "DEM/DET(ì¼)" not in df.columns and "ë°˜ì¶œì¼" in df.columns:
        df["DEM/DET(ì¼)"] = (df["ë°˜ì¶œì¼"] - df["ì…ê³ ì¼"]).dt.days - 3
        df["DEM/DET(ì¼)"] = df["DEM/DET(ì¼)"].apply(lambda x: x if x > 0 else 0)
    
    # ì›” í•„ë“œ ìƒì„±
    df["ì›”"] = df["ì…ê³ ì¼"].dt.to_period("M").astype(str)
    df['YYYYMM'] = df["ì›”"]
    
    return df

def create_sample_data():
    """ìƒ˜í”Œ ë°ì´í„° ìƒì„±"""
    import numpy as np
    
    dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
    sample_data = []
    
    for i in range(100):
        date = np.random.choice(dates)
        sample_data.append({
            'HVDC CODE': f'HVDC{i:04d}',
            'CATEGORY': np.random.choice(['ì „ì', 'ì‚¬ë¬´', 'OOG']),
            'MAIN DESCRIPTION (PO)': f'Item {i}',
            '20DC': np.random.randint(0, 5),
            '40DC': np.random.randint(0, 3),
            '40HQ': np.random.randint(0, 2),
            '40FR(IN)': np.random.randint(0, 1),
            'SHIP\n MODE': np.random.choice(['Normal', 'OOG', 'FR']),
            'Status_Location_Date_Year': date.year,
            'Status_Location_Date_Month': date.month,
            'DSV Indoor': np.random.choice([0, 1]),
            'DSV Outdoor': np.random.choice([0, 1]),
            'AAA Storage': np.random.choice([0, 1]),
            'DUTY AMT\n (AED)': np.random.uniform(1000, 50000),
            'VAT AMT\n (AED)': np.random.uniform(500, 2500)
        })
    
    df = pd.DataFrame(sample_data)
    return process_excel_data(df)

# 2. ë°ì´í„° ë¡œë“œ
df = load_hvdc_data()

# 3. í•„í„° ì˜µì…˜ ìƒì„±
years = sorted(df['YEAR'].dropna().unique()) if 'YEAR' in df.columns else [2024]
months = sorted(df['MONTH'].dropna().unique()) if 'MONTH' in df.columns else [1]
categories = ["All"] + df['CATEGORY'].dropna().unique().tolist() if 'CATEGORY' in df.columns else ["All"]
warehouses = ["All"] + df['WAREHOUSE'].dropna().unique().tolist() if 'WAREHOUSE' in df.columns else ["All"]

# 4. ëŒ€ì‹œë³´ë“œ ìƒíƒœ ë³€ìˆ˜
selected_year = years[0] if years else 2024
selected_month = months[0] if months else 1
selected_category = "All"
selected_warehouse = "All"
selected_tab = "TEU Trend"

# KPI ë³€ìˆ˜
total_teu = 0
oog_cnt = 0
duty_amt = 0.0
vat_amt = 0.0
dem_det_days = 0
occupancy_rate = 0.0

# 5. í•„í„° ë° KPI ê³„ì‚° í•¨ìˆ˜
def apply_filter(state):
    d = df.copy()
    
    # ì—°ë„/ì›” í•„í„°
    if hasattr(state, 'selected_year') and state.selected_year:
        d = d[d['YEAR'] == state.selected_year]
    if hasattr(state, 'selected_month') and state.selected_month:
        d = d[d['MONTH'] == state.selected_month]
    
    # ì¹´í…Œê³ ë¦¬/ì°½ê³  í•„í„°
    if hasattr(state, 'selected_category') and state.selected_category != "All":
        d = d[d['CATEGORY'] == state.selected_category]
    if hasattr(state, 'selected_warehouse') and state.selected_warehouse != "All":
        d = d[d['WAREHOUSE'] == state.selected_warehouse]

    # KPI ê³„ì‚°
    state.total_teu = int(d['TEU'].sum()) if 'TEU' in d.columns else 0
    state.oog_cnt = int(d['OOG'].sum()) if 'OOG' in d.columns else 0
    state.duty_amt = d['DUTY AMT\n (AED)'].sum() if 'DUTY AMT\n (AED)' in d.columns else 0.0
    state.vat_amt = d['VAT AMT\n (AED)'].sum() if 'VAT AMT\n (AED)' in d.columns else 0.0
    
    # DEM/DET ë° ì ìœ ìœ¨ ê³„ì‚°
    if 'DEM/DET(ì¼)' in d.columns:
        state.dem_det_days = int(d['DEM/DET(ì¼)'].sum())
    else:
        state.dem_det_days = 0
    
    # ì°½ê³  ì ìœ ìœ¨ (ê°€ì •: ì „ì²´ 10,000ã¡)
    if 'ì°½ê³ ë©´ì ' in d.columns:
        state.occupancy_rate = d['ì°½ê³ ë©´ì '].sum() / 10000
    else:
        state.occupancy_rate = len(d) / 1000  # ìƒ˜í”Œ ê³„ì‚°

    # ì‹œê°í™” ë°ì´í„°
    if 'YYYYMM' in d.columns:
        state.monthly_teu = d.groupby('YYYYMM')['TEU'].sum().reset_index()
    else:
        state.monthly_teu = pd.DataFrame({'YYYYMM': ['2024-01'], 'TEU': [state.total_teu]})
    
    # KPI í…Œì´ë¸”
    display_cols = ['HVDC CODE', 'CATEGORY', 'MAIN DESCRIPTION (PO)', 'TEU', 'OOG', 'WAREHOUSE']
    if 'DUTY AMT\n (AED)' in d.columns:
        display_cols.append('DUTY AMT\n (AED)')
    if 'VAT AMT\n (AED)' in d.columns:
        display_cols.append('VAT AMT\n (AED)')
    
    state.kpi_table = d[display_cols] if all(col in d.columns for col in display_cols) else d.head()
    state.raw_data = d

def on_change(state, var, val):
    if var in {"selected_year", "selected_month", "selected_category", "selected_warehouse", "selected_tab"}:
        apply_filter(state)

def on_init(state):
    apply_filter(state)

# 6. Taipy UI êµ¬ì¡°
import taipy.gui.builder as tgb

with tgb.Page() as page:
    tgb.text("# ğŸš¢ HVDC í”„ë¡œì íŠ¸ ë¬¼ë¥˜ KPI ëŒ€ì‹œë³´ë“œ â”‚ ì‚¼ì„±C&T (ADNOC/DSV)", mode="md")
    
    # í•„í„° ì„¹ì…˜
    with tgb.layout(columns="1 1 1 1"):
        tgb.text("**ì—°ë„**")
        tgb.selector(value="{selected_year}", lov=years, dropdown=True)
        tgb.text("**ì›”**")
        tgb.selector(value="{selected_month}", lov=months, dropdown=True)
        tgb.text("**ì¹´í…Œê³ ë¦¬**")
        tgb.selector(value="{selected_category}", lov=categories, dropdown=True)
        tgb.text("**ì°½ê³ **")
        tgb.selector(value="{selected_warehouse}", lov=warehouses, dropdown=True)
    
    # KPI ìš”ì•½
    tgb.text("## ğŸ“Š KPI ìš”ì•½", mode="md")
    with tgb.layout(columns="1 1 1 1"):
        tgb.text("**TEU í•©ê³„**\n{int(total_teu)}")
        tgb.text("**OOG ê±´ìˆ˜**\n{int(oog_cnt)}")
        tgb.text("**ê´€ì„¸**\n{duty_amt:,.0f} AED")
        tgb.text("**VAT**\n{vat_amt:,.0f} AED")
    
    # ì¶”ê°€ KPI (ìˆëŠ” ê²½ìš°)
    if 'dem_det_days' in locals():
        with tgb.layout(columns="1 1"):
            tgb.text("**DEM/DET(ì¼)**\n{int(dem_det_days)}")
            tgb.text("**ì°½ê³ ì ìœ ìœ¨**\n{(occupancy_rate * 100):.1f}%")
    
    # íƒ­ ì„ íƒ
    tgb.selector(value="{selected_tab}", lov=["TEU Trend", "KPI Table", "Raw Data"], dropdown=True)
    
    # íƒ­ë³„ ì½˜í…ì¸ 
    with tgb.part(render="{selected_tab == 'TEU Trend'}"):
        tgb.chart(data="{monthly_teu}", x="YYYYMM", y="TEU", type="bar", title="ğŸ“ˆ ì›”ë³„ TEU ì¶”ì´")
    
    with tgb.part(render="{selected_tab == 'KPI Table'}"):
        tgb.table(data="{kpi_table}", title="ğŸ“‹ KPI ìƒì„¸ í…Œì´ë¸”")
    
    with tgb.part(render="{selected_tab == 'Raw Data'}"):
        tgb.table(data="{raw_data}", title="ğŸ“„ ì›ë³¸ ë°ì´í„°")

# 7. ì‹¤í–‰
if __name__ == "__main__":
    print("ğŸš€ HVDC ëŒ€ì‹œë³´ë“œ ì‹œì‘...")
    print(f"ğŸ“Š ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {len(df)} ê±´")
    print(f"ğŸ“… ê¸°ê°„: {df['YEAR'].min() if 'YEAR' in df.columns else 'N/A'} ~ {df['YEAR'].max() if 'YEAR' in df.columns else 'N/A'}")
    
    Gui(page).run(
        title="HVDC Logistics Dashboard", 
        port="auto", 
        dark_mode=True, 
        debug=True,
        show_upload=False
    )
