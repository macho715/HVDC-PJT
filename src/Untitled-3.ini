# HVDC Excel Reporter Final í•µì‹¬ í•¨ìˆ˜ ì „ì²´ ì½”ë“œ ë¶€ë¡

## ğŸ“‹ ê°œìš”
ì´ ë¬¸ì„œëŠ” HVDC Excel Reporter Final ì‹œìŠ¤í…œì˜ ëª¨ë“  í•µì‹¬ í•¨ìˆ˜ë“¤ì˜ ì™„ì „í•œ ì½”ë“œ ì˜ˆì‹œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
ê° í•¨ìˆ˜ëŠ” ì‹¤ì œ êµ¬í˜„ ì½”ë“œ, ìƒì„¸í•œ ì£¼ì„, ì‚¬ìš© ì˜ˆì‹œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

---

## ğŸ”§ 1. ê³µí†µ í—¬í¼ í•¨ìˆ˜ë“¤

### 1.1 PKG ìˆ˜ëŸ‰ ì•ˆì „ ì¶”ì¶œ í•¨ìˆ˜
```python
def _get_pkg(row):
    """
    Pkg ì»¬ëŸ¼ì—ì„œ ìˆ˜ëŸ‰ì„ ì•ˆì „í•˜ê²Œ ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    
    Args:
        row: pandas Series - ë°ì´í„° í–‰
        
    Returns:
        int: PKG ìˆ˜ëŸ‰ (ê¸°ë³¸ê°’: 1)
        
    ì‚¬ìš© ì˜ˆì‹œ:
        pkg_quantity = _get_pkg(row)
        total_inbound += pkg_quantity  # count=1 ëŒ€ì‹  ì‹¤ì œ ìˆ˜ëŸ‰ ì‚¬ìš©
    """
    pkg_value = row.get('Pkg', 1)
    if pd.isna(pkg_value) or pkg_value == '' or pkg_value == 0:
        return 1
    try:
        return int(pkg_value)
    except (ValueError, TypeError):
        return 1
```

### 1.2 KPI ì„ê³„ê°’ ê²€ì¦ í•¨ìˆ˜
```python
def validate_kpi_thresholds(stats: Dict) -> Dict:
    """
    KPI ì„ê³„ê°’ ê²€ì¦ (Status_Location ê¸°ë°˜ íŒ¨ì¹˜ ë²„ì „)
    
    Args:
        stats: Dict - í†µê³„ ë°ì´í„°
        
    Returns:
        Dict: ê²€ì¦ ê²°ê³¼
        
    ê²€ì¦ í•­ëª©:
    - PKG Accuracy: 99% ì´ìƒ
    - Site Inventory Days: 30ì¼ ì´í•˜
    - Status_Location Validation: í•©ê³„ > 0
    - Inbound â‰¥ Outbound: ì…ê³  â‰¥ ì¶œê³ 
    """
    logger.info("ğŸ“Š KPI ì„ê³„ê°’ ê²€ì¦ ì‹œì‘ (Status_Location ê¸°ë°˜)")
    
    validation_results = {}
    
    # PKG Accuracy ê²€ì¦
    if 'processed_data' in stats:
        df = stats['processed_data']
        total_pkg = df['Pkg'].sum() if 'Pkg' in df.columns else 0
        total_records = len(df)
        
        if total_records > 0:
            pkg_accuracy = (total_pkg / total_records) * 100
            validation_results['PKG_Accuracy'] = {
                'status': 'PASS' if pkg_accuracy >= 99.0 else 'FAIL',
                'value': f"{pkg_accuracy:.2f}%",
                'threshold': '99.0%'
            }
    
    # Status_Location ê¸°ë°˜ ì¬ê³  ê²€ì¦
    if 'inventory_result' in stats:
        inventory_result = stats['inventory_result']
        if 'status_location_distribution' in inventory_result:
            location_dist = inventory_result['status_location_distribution']
            total_by_status = sum(location_dist.values())
            
            validation_results['Status_Location_Validation'] = {
                'status': 'PASS' if total_by_status > 0 else 'FAIL',
                'value': f"{total_by_status}ê±´",
                'threshold': 'Status_Location í•©ê³„ > 0'
            }
            
            # í˜„ì¥ ì¬ê³ ì¼ìˆ˜ ê²€ì¦ (30ì¼ ì´í•˜)
            site_locations = ['AGI', 'DAS', 'MIR', 'SHU']
            site_inventory = sum(location_dist.get(site, 0) for site in site_locations)
            
            validation_results['Site_Inventory_Days'] = {
                'status': 'PASS' if site_inventory <= 30 else 'FAIL',
                'value': f"{site_inventory}ì¼",
                'threshold': '30ì¼'
            }
    
    # ì…ê³  â‰¥ ì¶œê³  ê²€ì¦
    if 'inbound_result' in stats and 'outbound_result' in stats:
        total_inbound = stats['inbound_result']['total_inbound']
        total_outbound = stats['outbound_result']['total_outbound']
        
        validation_results['Inbound_Outbound_Ratio'] = {
            'status': 'PASS' if total_inbound >= total_outbound else 'FAIL',
            'value': f"{total_inbound} â‰¥ {total_outbound}",
            'threshold': 'ì…ê³  â‰¥ ì¶œê³ '
        }
    
    all_pass = all(result['status'] == 'PASS' for result in validation_results.values())
    
    logger.info(f"âœ… Status_Location ê¸°ë°˜ KPI ê²€ì¦ ì™„ë£Œ: {'ALL PASS' if all_pass else 'SOME FAILED'}")
    return validation_results
```

---

## ğŸ­ 2. WarehouseIOCalculator í´ë˜ìŠ¤ í•µì‹¬ í•¨ìˆ˜ë“¤

### 2.1 í´ë˜ìŠ¤ ì´ˆê¸°í™”
```python
class WarehouseIOCalculator:
    """
    Excel ìˆ˜ì‹ ê¸°ë°˜ ì°½ê³  ì…ì¶œê³  ê³„ì‚° í´ë˜ìŠ¤
    
    StatusCalculatorë¥¼ í™œìš©í•˜ì—¬ ì •í™•í•œ ì°½ê³  ì…ì¶œê³  ì§‘ê³„ ìˆ˜í–‰
    - ì…ê³ : warehouse ìƒíƒœì¸ í•­ëª©ë“¤ì˜ ì›”ë³„ ì§‘ê³„
    - ì¶œê³ : warehouse â†’ site ì´ë™ ë˜ëŠ” ì°½ê³  íƒ€ì…ë³„ ì¶œê³ ìœ¨ ì ìš©
    - ì¬ê³ : í˜„ì¬ warehouse ìƒíƒœ ìœ ì§€ í•­ëª©ë“¤
    """
    
    def __init__(self):
        self.status_calculator = StatusCalculator()
        
        # ì°½ê³  íƒ€ì…ë³„ ì¶œê³ ìœ¨ ì„¤ì •
        self.outbound_rates = {
            'DSV Indoor': 0.80,      # ì¼ë°˜ì°½ê³ 
            'DSV Outdoor': 0.60,     # Offshore
            'DSV Al Markaz': 0.90,   # Central
            'DSV MZP': 0.80,         # ì¼ë°˜ì°½ê³ 
            'AAA  Storage': 0.80,    # ì¼ë°˜ì°½ê³  (ê³µë°± ì£¼ì˜)
            'AAA Storage': 0.80,     # ì¼ë°˜ì°½ê³  (ê³µë°± ì—†ìŒ)
            'Hauler Indoor': 0.80,   # ì¼ë°˜ì°½ê³ 
            'MOSB': 0.60,            # Offshore
            'DHL Warehouse': 0.80    # ì¼ë°˜ì°½ê³ 
        }
        
        # ì°½ê³  ì»¬ëŸ¼ëª… ë§¤í•‘ (í‘œì¤€í™”)
        self.warehouse_columns = [
            'DSV Indoor', 'DSV Outdoor', 'DSV Al Markaz', 'DSV MZP',
            'AAA  Storage', 'AAA Storage', 'Hauler Indoor', 'MOSB', 'DHL Warehouse'
        ]
        
        # í˜„ì¥ ì»¬ëŸ¼ëª…
        self.site_columns = ['MIR', 'SHU', 'DAS', 'AGI']
        
        # Final Location ê³„ì‚°ì„ ìœ„í•œ íŠ¹ë³„ ì»¬ëŸ¼ ë§¤í•‘
        self.special_location_columns = {
            'DSV Al Markaz': 'Status_Location_DSV Al Markaz',  # AX
            'DSV Indoor': 'Status_Location_DSV Indoor'        # AY
        }
```

### 2.2 Final Location ê³„ì‚° í•¨ìˆ˜
```python
def calculate_final_location(self, df: pd.DataFrame) -> pd.DataFrame:
    """
    Final_Location íŒŒìƒ ë¡œì§ (np.select ì‚¬ìš©)
    - DSV Al Markaz â†’ AX ì»¬ëŸ¼ ìš°ì„  ì°¸ì¡°
    - DSV Indoor â†’ AY ì»¬ëŸ¼ ìš°ì„  ì°¸ì¡°
    - ë‚˜ë¨¸ì§€ â†’ Status_Location(AV) ì»¬ëŸ¼ ì‚¬ìš©
    
    Args:
        df: pd.DataFrame - ì…ë ¥ ë°ì´í„°
        
    Returns:
        pd.DataFrame: Final_Location ì»¬ëŸ¼ì´ ì¶”ê°€ëœ ë°ì´í„°í”„ë ˆì„
        
    ì‚¬ìš© ì˜ˆì‹œ:
        result_df = calculator.calculate_final_location(df)
        final_locations = result_df['Final_Location'].value_counts()
    """
    result_df = df.copy()
    
    # ìƒíƒœ ê³„ì‚°ì´ ì•ˆë˜ì–´ ìˆìœ¼ë©´ ë¨¼ì € ê³„ì‚°
    if 'Status_Location' not in result_df.columns:
        result_df = self.status_calculator.calculate_complete_status(result_df)
    
    # ì—´ ë§¤í•‘ (ê°€ì •)
    COL_LOC_ALL = 'Status_Location'                    # AV
    COL_DSV_MARKAZ = 'Status_Location_DSV Al Markaz'   # AX
    COL_DSV_INDOOR = 'Status_Location_DSV Indoor'      # AY
    
    # AX, AY ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ìƒì„± (ì„ì‹œ)
    if COL_DSV_MARKAZ not in result_df.columns:
        result_df[COL_DSV_MARKAZ] = ''
    if COL_DSV_INDOOR not in result_df.columns:
        result_df[COL_DSV_INDOOR] = ''
    
    # 1) AL MARKAZ â†’ AX, INDOOR â†’ AY, ë‚˜ë¨¸ì§€ â†’ AV
    result_df['Final_Location'] = np.select(
        [
            result_df[COL_DSV_MARKAZ].notna() & result_df[COL_DSV_MARKAZ].ne(''),
            result_df[COL_DSV_INDOOR].notna() & result_df[COL_DSV_INDOOR].ne('')
        ],
        [
            result_df[COL_DSV_MARKAZ],          # AL MARKAZ
            result_df[COL_DSV_INDOOR]           # INDOOR
        ],
        default=result_df[COL_LOC_ALL]          # ê·¸ ì™¸
    )
    
    # 2) í™•ì¸: ì¤‘ë³µÂ·ê³µë°± ì œê±°
    result_df['Final_Location'] = result_df['Final_Location'].astype(str).str.strip()
    result_df.loc[result_df['Final_Location'] == '', 'Final_Location'] = 'ë¯¸ì •'
    
    return result_df
```

### 2.3 ì°½ê³  ì…ê³  ê³„ì‚° í•¨ìˆ˜
```python
def calculate_warehouse_inbound(self, df: pd.DataFrame) -> Dict:
    """
    ì°½ê³  ì…ê³  ê³„ì‚° (Final_Location ê¸°ë°˜ + ì›”ë³„ í”¼ë²—)
    - Final_Location ê¸°ì¤€ìœ¼ë¡œ ì •í™•í•œ ìœ„ì¹˜ íŒŒì•…
    - ì›”ë³„ ì…ê³ ëŸ‰ í”¼ë²— í…Œì´ë¸” ìƒì„±
    
    Args:
        df: pd.DataFrame - ì…ë ¥ ë°ì´í„°
        
    Returns:
        Dict: {
            'total_inbound': int,
            'by_warehouse': Dict[str, int],
            'by_month': Dict[str, int],
            'by_warehouse_month': Dict[str, Dict[str, int]],
            'monthly_pivot': pd.DataFrame,
            'inbound_date_column': str
        }
        
    ì‚¬ìš© ì˜ˆì‹œ:
        inbound_result = calculator.calculate_warehouse_inbound(df)
        print(f"ì´ ì…ê³ : {inbound_result['total_inbound']}ê±´")
        print(f"ì°½ê³ ë³„: {inbound_result['by_warehouse']}")
    """
    # Final_Location ê³„ì‚°
    result_df = self.calculate_final_location(df)
    
    # warehouse ìƒíƒœ í•­ëª©ë§Œ í•„í„°ë§
    warehouse_items = result_df[result_df['Status_Current'] == 'warehouse']
    
    # ì…ê³  ë‚ ì§œ ì»¬ëŸ¼ ì°¾ê¸° (ê°€ëŠ¥í•œ í›„ë³´ë“¤)
    inbound_date_candidates = [
        'Inbound_Date', 'Arrival_Date', 'Warehouse_In_Date',
        'Entry_Date', 'Received_Date'
    ]
    
    inbound_date_col = None
    for col in inbound_date_candidates:
        if col in result_df.columns:
            inbound_date_col = col
            break
    
    # ì…ê³  ë‚ ì§œê°€ ì—†ìœ¼ë©´ Final_Locationì˜ ë‚ ì§œ ì‚¬ìš©
    if inbound_date_col is None:
        warehouse_items = warehouse_items.copy()
        warehouse_items['Inbound_Date'] = warehouse_items.apply(
            lambda row: row.get(row['Final_Location'], None) 
            if row['Final_Location'] in row.index else None, 
            axis=1
        )
        inbound_date_col = 'Inbound_Date'
    
    # ì›”ë³„ ê³„ì‚°ì„ ìœ„í•œ ë°ì´í„° ì¤€ë¹„
    if inbound_date_col in warehouse_items.columns:
        warehouse_items = warehouse_items.copy()
        warehouse_items['Inbound_Month'] = pd.to_datetime(
            warehouse_items[inbound_date_col], errors='coerce'
        ).dt.to_period('M')
    else:
        warehouse_items['Inbound_Month'] = None
    
    # ì§‘ê³„ ê²°ê³¼ ì´ˆê¸°í™”
    inbound_summary = {
        'total_inbound': len(warehouse_items),
        'by_warehouse': defaultdict(int),
        'by_month': defaultdict(int),
        'by_warehouse_month': defaultdict(lambda: defaultdict(int)),
        'inbound_date_column': inbound_date_col or 'None'
    }
    
    # ì°½ê³ ë³„, ì›”ë³„ ì§‘ê³„
    for _, row in warehouse_items.iterrows():
        location = row['Final_Location']
        month = row['Inbound_Month']
        
        # ì§‘ê³„ ì—…ë°ì´íŠ¸
        inbound_summary['by_warehouse'][location] += 1
        
        if pd.notna(month):
            month_key = str(month)
            inbound_summary['by_month'][month_key] += 1
            inbound_summary['by_warehouse_month'][location][month_key] += 1
    
    # ì›”ë³„ í”¼ë²— í…Œì´ë¸” ìƒì„±
    try:
        if inbound_date_col and 'Inbound_Month' in warehouse_items.columns:
            monthly_pivot = warehouse_items.pivot_table(
                index='Inbound_Month',
                columns='Final_Location',
                values='Item' if 'Item' in warehouse_items.columns else warehouse_items.columns[0],
                aggfunc='count',
                fill_value=0
            ).astype(int)
        else:
            monthly_pivot = pd.DataFrame()
    except Exception as e:
        print(f"í”¼ë²— í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨: {e}")
        monthly_pivot = pd.DataFrame()
    
    # defaultdictë¥¼ ì¼ë°˜ dictë¡œ ë³€í™˜
    inbound_summary['by_warehouse'] = dict(inbound_summary['by_warehouse'])
    inbound_summary['by_month'] = dict(inbound_summary['by_month'])
    inbound_summary['by_warehouse_month'] = {
        wh: dict(months) for wh, months in inbound_summary['by_warehouse_month'].items()
    }
    inbound_summary['monthly_pivot'] = monthly_pivot
    
    return inbound_summary
```

### 2.4 ì°½ê³  ì¶œê³  ê³„ì‚° í•¨ìˆ˜
```python
def calculate_warehouse_outbound(self, df: pd.DataFrame) -> Dict:
    """
    ì°½ê³  ì¶œê³  ê³„ì‚° (ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸ ë°©ì‹)
    - ì¶œê³  ì´ë²¤íŠ¸ ì¤‘ë³µ ì œê±°
    - ì‹¤ì œ ì°½ê³  â†’ í˜„ì¥ ì´ë™ ì´ë²¤íŠ¸ë§Œ ì¹´ìš´íŠ¸
    
    Args:
        df: pd.DataFrame - ì…ë ¥ ë°ì´í„°
        
    Returns:
        Dict: {
            'total_outbound': int,
            'by_warehouse': Dict[str, int],
            'by_site': Dict[str, int],
            'outbound_events': pd.DataFrame
        }
        
    ì‚¬ìš© ì˜ˆì‹œ:
        outbound_result = calculator.calculate_warehouse_outbound(df)
        print(f"ì´ ì¶œê³ : {outbound_result['total_outbound']}ê±´")
    """
    warehouse_cols = self.warehouse_columns
    site_cols = self.site_columns
    
    # ëª¨ë“  ë‚ ì§œ ì»¬ëŸ¼ melt
    long_df = df.melt(
        id_vars=['Item'] if 'Item' in df.columns else [df.columns[0]],
        value_vars=warehouse_cols + site_cols,
        var_name='Location',
        value_name='Date'
    ).dropna()
    
    # ë‚ ì§œí˜• ë³€í™˜ ë° ì •ë ¬
    long_df['Date'] = pd.to_datetime(long_df['Date'], errors='coerce')
    long_df = long_df.sort_values(['Item', 'Date'])
    
    # ì´ì „ Location ëŒ€ë¹„ ë³€í™” ì‹œ ì¶œê³  ì´ë²¤íŠ¸ ë§ˆí‚¹
    long_df['Prev_Location'] = long_df.groupby('Item')['Location'].shift()
    
    # ì°½ê³  â†’ í˜„ì¥ ì´ë™ë§Œ ì¶œê³ ë¡œ ê³„ì‚°
    outbound_events = long_df[
        long_df['Prev_Location'].isin(warehouse_cols) &
        long_df['Location'].isin(site_cols)
    ]
    
    # ì§‘ê³„
    by_warehouse = outbound_events['Prev_Location'].value_counts().to_dict()
    by_site = outbound_events['Location'].value_counts().to_dict()
    
    return {
        'total_outbound': len(outbound_events),
        'by_warehouse': by_warehouse,
        'by_site': by_site,
        'outbound_events': outbound_events
    }
```

### 2.5 ì°½ê³  ì¬ê³  ê³„ì‚° í•¨ìˆ˜
```python
def calculate_warehouse_inventory(self, df: pd.DataFrame) -> Dict:
    """
    ì°½ê³  ì¬ê³  ê³„ì‚° (Status_Location ê¸°ë°˜)
    - í˜„ì¬ warehouse ìƒíƒœ ìœ ì§€ í•­ëª©ë“¤
    - 5% ì†Œë¹„ìœ¨ ê°€ì •ì¹˜ ì œê±°, ì‹¤ì‹œê°„ Location ê¸°ë°˜ ê³„ì‚°
    
    Args:
        df: pd.DataFrame - ì…ë ¥ ë°ì´í„°
        
    Returns:
        Dict: {
            'total_inventory': int,
            'by_warehouse': Dict[str, int],
            'by_status': Dict[str, int],
            'status_location_distribution': Dict[str, int]
        }
        
    ì‚¬ìš© ì˜ˆì‹œ:
        inventory_result = calculator.calculate_warehouse_inventory(df)
        print(f"ì´ ì¬ê³ : {inventory_result['total_inventory']}ê±´")
    """
    # ìƒíƒœ ê³„ì‚°
    result_df = self.status_calculator.calculate_complete_status(df)
    
    # ìƒíƒœë³„ ì§‘ê³„ (ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜, ì†Œë¹„ìœ¨ ê°€ì •ì¹˜ ì—†ìŒ)
    status_counts = result_df['Status_Current'].value_counts()
    
    inventory_summary = {
        'total_inventory': status_counts.get('warehouse', 0),
        'by_warehouse': defaultdict(int),
        'by_status': {
            'warehouse': status_counts.get('warehouse', 0),
            'site': status_counts.get('site', 0),
            'pre_arrival': status_counts.get('Pre Arrival', 0)
        },
        'status_location_distribution': result_df['Status_Location'].value_counts().to_dict()
    }
    
    # ì°½ê³ ë³„ ì¬ê³  ì§‘ê³„ (ì‹¤ì‹œê°„ Status_Location ê¸°ë°˜)
    warehouse_items = result_df[result_df['Status_Current'] == 'warehouse']
    for _, row in warehouse_items.iterrows():
        location = row['Status_Location']
        inventory_summary['by_warehouse'][location] += 1
    
    # defaultdictë¥¼ ì¼ë°˜ dictë¡œ ë³€í™˜
    inventory_summary['by_warehouse'] = dict(inventory_summary['by_warehouse'])
    
    return inventory_summary
```

### 2.6 ì§ë°°ì†¡ ê³„ì‚° í•¨ìˆ˜
```python
def calculate_direct_delivery(self, df: pd.DataFrame) -> Dict:
    """
    ë¶€ë‘â†’í˜„ì¥ ì§ë°°ì†¡ ê³„ì‚°
    - ì°½ê³ ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ë°”ë¡œ í˜„ì¥ìœ¼ë¡œ ê°„ í•­ëª©ë“¤
    - site ìƒíƒœì´ë©´ì„œ ì°½ê³  ì»¬ëŸ¼ì— ë‚ ì§œê°€ ì—†ëŠ” ê²½ìš°
    
    Args:
        df: pd.DataFrame - ì…ë ¥ ë°ì´í„°
        
    Returns:
        Dict: {
            'total_direct': int,
            'by_site': Dict[str, int],
            'by_month': Dict[str, int],
            'direct_items': pd.DataFrame
        }
        
    ì‚¬ìš© ì˜ˆì‹œ:
        direct_result = calculator.calculate_direct_delivery(df)
        print(f"ì§ë°°ì†¡: {direct_result['total_direct']}ê±´")
    """
    # Final_Location ê³„ì‚°
    result_df = self.calculate_final_location(df)
    
    # site ìƒíƒœ í•­ëª©ë“¤
    site_items = result_df[result_df['Status_Current'] == 'site'].copy()
    
    # ì§ë°°ì†¡ ì¡°ê±´: ëª¨ë“  ì°½ê³  ì»¬ëŸ¼ì— ë‚ ì§œê°€ ì—†ê³  í˜„ì¥ ì»¬ëŸ¼ì—ë§Œ ë‚ ì§œê°€ ìˆëŠ” ê²½ìš°
    direct_mask = pd.Series(True, index=site_items.index)
    
    # ëª¨ë“  ì°½ê³  ì»¬ëŸ¼ ì²´í¬
    for col in self.warehouse_columns:
        if col in site_items.columns:
            # í•´ë‹¹ ì°½ê³  ì»¬ëŸ¼ì— ë‚ ì§œê°€ ìˆìœ¼ë©´ ì§ë°°ì†¡ì´ ì•„ë‹˜
            has_warehouse_date = site_items[col].notna()
            direct_mask = direct_mask & ~has_warehouse_date
    
    # ì§ë°°ì†¡ í•­ëª© í•„í„°ë§
    direct_items = site_items[direct_mask].copy()
    
    # ì§‘ê³„
    by_site = direct_items['Status_Location'].value_counts().to_dict()
    by_month = {}
    
    # ì›”ë³„ ì§‘ê³„ (í˜„ì¥ ë„ì°©ì¼ ê¸°ì¤€)
    for site in self.site_columns:
        if site in direct_items.columns:
            site_dates = direct_items[site].dropna()
            for date in site_dates:
                month_key = pd.to_datetime(date).strftime('%Y-%m')
                by_month[month_key] = by_month.get(month_key, 0) + 1
    
    return {
        'total_direct': len(direct_items),
        'by_site': by_site,
        'by_month': by_month,
        'direct_items': direct_items
    }
```

---

## ğŸ“Š 3. HVDCExcelReporterFinal í´ë˜ìŠ¤ í•µì‹¬ í•¨ìˆ˜ë“¤

### 3.1 í´ë˜ìŠ¤ ì´ˆê¸°í™”
```python
class HVDCExcelReporterFinal:
    """
    HVDC Excel Reporter Final í´ë˜ìŠ¤
    - Multi-Level Header ì§€ì›
    - ì°½ê³ /í˜„ì¥ ì‹œíŠ¸ ìƒì„±
    - Flow ë¶„ì„ ì‹œíŠ¸ ìƒì„±
    """
    
    def __init__(self):
        self.calculator = WarehouseIOCalculator()
        
        # ì°½ê³  ìš°ì„ ìˆœìœ„ (ë™ì¼ì¼ì íƒ€ì´ë¸Œë ˆì´ì»¤)
        self.warehouse_priority = [
            'DSV Al Markaz', 'DSV Indoor', 'DSV Outdoor',
            'AAA Storage', 'Hauler Indoor', 'DSV MZP', 'MOSB'
        ]
        
        # Flow Code ë§¤í•‘
        self.flow_codes = {
            'F1': 'ì°½ê³  ì…ê³ ',
            'F2': 'ì°½ê³  ì¶œê³ ',
            'F3': 'í˜„ì¥ ì…ê³ ',
            'F4': 'í˜„ì¥ ì¬ê³ ',
            'F5': 'ì§ë°°ì†¡',
            'F6': 'ì°½ê³  ê°„ ì´ë™'
        }
```

### 3.2 ì°½ê³  í†µê³„ ê³„ì‚° í•¨ìˆ˜
```python
def calculate_warehouse_statistics(self) -> Dict:
    """
    ì°½ê³  í†µê³„ ê³„ì‚° (í†µí•©)
    
    Returns:
        Dict: ëª¨ë“  ì°½ê³  ê´€ë ¨ í†µê³„
        
    ì‚¬ìš© ì˜ˆì‹œ:
        stats = reporter.calculate_warehouse_statistics()
        warehouse_sheet = reporter.create_warehouse_monthly_sheet(stats)
    """
    # ë°ì´í„° ë¡œë“œ
    df = self.calculator.load_real_hvdc_data()
    
    # ê°ì¢… ê³„ì‚° ìˆ˜í–‰
    inbound_result = self.calculator.calculate_warehouse_inbound(df)
    outbound_result = self.calculator.calculate_warehouse_outbound(df)
    inventory_result = self.calculator.calculate_warehouse_inventory(df)
    direct_result = self.calculator.calculate_direct_delivery(df)
    
    return {
        'inbound_result': inbound_result,
        'outbound_result': outbound_result,
        'inventory_result': inventory_result,
        'direct_result': direct_result,
        'processed_data': df
    }
```

### 3.3 ì°½ê³  ì›”ë³„ ì‹œíŠ¸ ìƒì„± í•¨ìˆ˜
```python
def create_warehouse_monthly_sheet(self, stats: Dict) -> pd.DataFrame:
    """
    ì°½ê³  ì›”ë³„ ì‹œíŠ¸ ìƒì„± (17ì—´ êµ¬ì¡°)
    
    Args:
        stats: Dict - í†µê³„ ë°ì´í„°
        
    Returns:
        pd.DataFrame: ì°½ê³  ì›”ë³„ ì‹œíŠ¸
        
    ì»¬ëŸ¼ êµ¬ì¡°:
    ['ì…ê³ ì›”'] + 
    ['ì…ê³ _AAA Storage', 'ì…ê³ _DSV Al Markaz', ..., 'ì…ê³ _MOSB'] (7ê°œ) +
    ['ì¶œê³ _AAA Storage', 'ì¶œê³ _DSV Al Markaz', ..., 'ì¶œê³ _MOSB'] (7ê°œ) +
    ['ëˆ„ê³„_ì…ê³ ', 'ëˆ„ê³„_ì¶œê³ '] (2ê°œ)
    """
    inbound_result = stats['inbound_result']
    outbound_result = stats['outbound_result']
    
    # ì›”ë³„ ë°ì´í„° ìˆ˜ì§‘
    all_months = set()
    all_months.update(inbound_result['by_month'].keys())
    all_months.update(outbound_result.get('by_month', {}).keys())
    
    # ì‹œíŠ¸ ë°ì´í„° ìƒì„±
    sheet_data = []
    
    for month in sorted(all_months):
        row_data = {'ì…ê³ ì›”': month}
        
        # ì…ê³  ë°ì´í„°
        for warehouse in self.warehouse_priority:
            col_name = f'ì…ê³ _{warehouse}'
            inbound_count = inbound_result['by_warehouse_month'].get(warehouse, {}).get(month, 0)
            row_data[col_name] = inbound_count
        
        # ì¶œê³  ë°ì´í„°
        for warehouse in self.warehouse_priority:
            col_name = f'ì¶œê³ _{warehouse}'
            outbound_count = outbound_result.get('by_warehouse_month', {}).get(warehouse, {}).get(month, 0)
            row_data[col_name] = outbound_count
        
        # ëˆ„ê³„ ê³„ì‚°
        total_inbound = sum(row_data[f'ì…ê³ _{wh}'] for wh in self.warehouse_priority)
        total_outbound = sum(row_data[f'ì¶œê³ _{wh}'] for wh in self.warehouse_priority)
        
        row_data['ëˆ„ê³„_ì…ê³ '] = total_inbound
        row_data['ëˆ„ê³„_ì¶œê³ '] = total_outbound
        
        sheet_data.append(row_data)
    
    return pd.DataFrame(sheet_data)
```

### 3.4 í˜„ì¥ ì›”ë³„ ì‹œíŠ¸ ìƒì„± í•¨ìˆ˜
```python
def create_site_monthly_sheet(self, stats: Dict) -> pd.DataFrame:
    """
    í˜„ì¥ ì›”ë³„ ì‹œíŠ¸ ìƒì„± (9ì—´ êµ¬ì¡°)
    
    Args:
        stats: Dict - í†µê³„ ë°ì´í„°
        
    Returns:
        pd.DataFrame: í˜„ì¥ ì›”ë³„ ì‹œíŠ¸
        
    ì»¬ëŸ¼ êµ¬ì¡°:
    ['ì…ê³ ì›”'] + 
    ['ì…ê³ _AGI', 'ì…ê³ _DAS', 'ì…ê³ _MIR', 'ì…ê³ _SHU'] (4ê°œ) +
    ['ì¬ê³ _AGI', 'ì¬ê³ _DAS', 'ì¬ê³ _MIR', 'ì¬ê³ _SHU'] (4ê°œ)
    """
    inbound_result = stats['inbound_result']
    inventory_result = stats['inventory_result']
    
    # í˜„ì¥ ì»¬ëŸ¼
    site_columns = ['AGI', 'DAS', 'MIR', 'SHU']
    
    # ì›”ë³„ ë°ì´í„° ìˆ˜ì§‘
    all_months = set()
    all_months.update(inbound_result['by_month'].keys())
    
    # ì‹œíŠ¸ ë°ì´í„° ìƒì„±
    sheet_data = []
    
    for month in sorted(all_months):
        row_data = {'ì…ê³ ì›”': month}
        
        # ì…ê³  ë°ì´í„°
        for site in site_columns:
            col_name = f'ì…ê³ _{site}'
            inbound_count = inbound_result.get('by_site_month', {}).get(site, {}).get(month, 0)
            row_data[col_name] = inbound_count
        
        # ì¬ê³  ë°ì´í„° (í˜„ì¬ ìƒíƒœ ê¸°ì¤€)
        for site in site_columns:
            col_name = f'ì¬ê³ _{site}'
            inventory_count = inventory_result['by_warehouse'].get(site, 0)
            row_data[col_name] = inventory_count
        
        sheet_data.append(row_data)
    
    return pd.DataFrame(sheet_data)
```

### 3.5 Multi-Level Header ìƒì„± í•¨ìˆ˜
```python
def create_multi_level_headers(self, df: pd.DataFrame, sheet_type: str) -> pd.DataFrame:
    """
    Multi-Level Header ìƒì„±
    
    Args:
        df: pd.DataFrame - ë°ì´í„°í”„ë ˆì„
        sheet_type: str - ì‹œíŠ¸ íƒ€ì… ('warehouse' ë˜ëŠ” 'site')
        
    Returns:
        pd.DataFrame: Multi-Level Headerê°€ ì ìš©ëœ ë°ì´í„°í”„ë ˆì„
        
    ì‚¬ìš© ì˜ˆì‹œ:
        warehouse_df = create_multi_level_headers(warehouse_df, 'warehouse')
    """
    if sheet_type == 'warehouse':
        # ì°½ê³  ì‹œíŠ¸: 17ì—´ êµ¬ì¡°
        level_0 = ['ì…ê³ ì›”'] + ['ì…ê³ '] * 7 + ['ì¶œê³ '] * 7 + ['ëˆ„ê³„', 'ëˆ„ê³„']
        level_1 = [''] + self.warehouse_priority + self.warehouse_priority + ['ì…ê³ ', 'ì¶œê³ ']
        
    elif sheet_type == 'site':
        # í˜„ì¥ ì‹œíŠ¸: 9ì—´ êµ¬ì¡°
        level_0 = ['ì…ê³ ì›”'] + ['ì…ê³ '] * 4 + ['ì¬ê³ '] * 4
        level_1 = [''] + ['AGI', 'DAS', 'MIR', 'SHU'] + ['AGI', 'DAS', 'MIR', 'SHU']
    
    # MultiIndex ìƒì„±
    headers = pd.MultiIndex.from_arrays([level_0, level_1], names=['Level_0', 'Level_1'])
    
    # ë°ì´í„°í”„ë ˆì„ì— í—¤ë” ì ìš©
    df.columns = headers
    
    return df
```

---

## ğŸ”„ 4. ìµœì¢… ê³„ì‚° í•¨ìˆ˜ë“¤ (íŒ¨ì¹˜ ë²„ì „)

### 4.1 ì…ê³  ìµœì¢… ê³„ì‚° í•¨ìˆ˜
```python
def calculate_inbound_final(df: pd.DataFrame, location: str, year_month) -> int:
    """
    ì…ê³  = í•´ë‹¹ ìœ„ì¹˜ ì»¬ëŸ¼ì— ë‚ ì§œê°€ ìˆê³ , ê·¸ ë‚ ì§œê°€ í•´ë‹¹ ì›”ì¸ ê²½ìš°
    
    Args:
        df: pd.DataFrame - ì…ë ¥ ë°ì´í„°
        location: str - ìœ„ì¹˜ëª…
        year_month: Period - ë…„ì›”
        
    Returns:
        int: ì…ê³  ìˆ˜ëŸ‰ (PKG ìˆ˜ëŸ‰ ë°˜ì˜)
        
    ì‚¬ìš© ì˜ˆì‹œ:
        inbound_count = calculate_inbound_final(df, 'DSV Al Markaz', pd.Period('2024-01'))
    """
    inbound_count = 0
    for idx, row in df.iterrows():
        if location in row.index and pd.notna(row[location]):
            arrival_date = pd.to_datetime(row[location])
            if arrival_date.to_period('M') == year_month:
                pkg_quantity = _get_pkg(row)
                inbound_count += pkg_quantity  # PKG ìˆ˜ëŸ‰ ë°˜ì˜
    return inbound_count
```

### 4.2 ì¶œê³  ìµœì¢… ê³„ì‚° í•¨ìˆ˜
```python
def calculate_outbound_final(df: pd.DataFrame, location: str, year_month) -> int:
    """
    ì¶œê³  = í•´ë‹¹ ìœ„ì¹˜ ì´í›„ ë‹¤ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™ (ë‹¤ìŒ ìœ„ì¹˜ì˜ ë„ì°©ì¼ì´ ì¶œê³ ì¼)
    
    Args:
        df: pd.DataFrame - ì…ë ¥ ë°ì´í„°
        location: str - ìœ„ì¹˜ëª…
        year_month: Period - ë…„ì›”
        
    Returns:
        int: ì¶œê³  ìˆ˜ëŸ‰ (PKG ìˆ˜ëŸ‰ ë°˜ì˜)
        
    ì‚¬ìš© ì˜ˆì‹œ:
        outbound_count = calculate_outbound_final(df, 'DSV Al Markaz', pd.Period('2024-01'))
    """
    outbound_count = 0
    all_locations = [
        'DSV Indoor', 'DSV Al Markaz', 'DSV Outdoor', 'AAA Storage',
        'Hauler Indoor', 'DSV MZP', 'MOSB',
        'Shifting', 'MIR', 'SHU', 'DAS', 'AGI'
    ]
    
    # ìœ„ì¹˜ ìš°ì„ ìˆœìœ„ ì •ë ¬ í•¨ìˆ˜
    def _sort_key(loc):
        loc_priority = {
            'DSV Al Markaz': 1, 'DSV Indoor': 2, 'DSV Outdoor': 3,
            'AAA Storage': 4, 'Hauler Indoor': 5, 'DSV MZP': 6,
            'MOSB': 8, 'MIR': 9, 'SHU': 10, 'DAS': 11, 'AGI': 12
        }
        return loc_priority.get(loc, 99)
    
    for idx, row in df.iterrows():
        if location in row.index and pd.notna(row[location]):
            current_date = pd.to_datetime(row[location])
            next_movements = []
            
            for next_loc in all_locations:
                if next_loc != location and next_loc in row.index and pd.notna(row[next_loc]):
                    next_date = pd.to_datetime(row[next_loc])
                    if next_date >= current_date:  # ë™ì¼-ì¼ì ì´ë™ ì¸ì‹
                        next_movements.append((next_loc, next_date))
            
            if next_movements:
                # ë™ì¼ ë‚ ì§œ ë‹¤ì¤‘ ì´ë™ ì •ë ¬ (ë‚ ì§œ â†’ ìš°ì„ ìˆœìœ„)
                next_movements.sort(key=lambda x: (x[1], _sort_key(x[0])))
                next_location, next_date = next_movements[0]
                
                if next_date.to_period('M') == year_month:
                    pkg_quantity = _get_pkg(row)
                    outbound_count += pkg_quantity  # PKG ìˆ˜ëŸ‰ ë°˜ì˜
    
    return outbound_count
```

### 4.3 ì¬ê³  ìµœì¢… ê³„ì‚° í•¨ìˆ˜
```python
def calculate_inventory_final(df: pd.DataFrame, location: str, month_end) -> int:
    """
    ì¬ê³  = Status_Locationì´ í•´ë‹¹ ìœ„ì¹˜ì¸ ì•„ì´í…œ ìˆ˜ (ì›”ë§ ê¸°ì¤€)
    
    Args:
        df: pd.DataFrame - ì…ë ¥ ë°ì´í„°
        location: str - ìœ„ì¹˜ëª…
        month_end: datetime - ì›”ë§ ë‚ ì§œ
        
    Returns:
        int: ì¬ê³  ìˆ˜ëŸ‰ (PKG ìˆ˜ëŸ‰ ë°˜ì˜)
        
    ì‚¬ìš© ì˜ˆì‹œ:
        inventory_count = calculate_inventory_final(df, 'DSV Al Markaz', pd.Timestamp('2024-01-31'))
    """
    inventory_count = 0
    if 'Status_Location' in df.columns:
        at_location = df[df['Status_Location'] == location]
        for idx, row in at_location.iterrows():
            if location in row.index and pd.notna(row[location]):
                arrival_date = pd.to_datetime(row[location])
                if arrival_date <= month_end:
                    pkg_quantity = _get_pkg(row)
                    inventory_count += pkg_quantity  # PKG ìˆ˜ëŸ‰ ë°˜ì˜
    return inventory_count
```

---

## ğŸ“‹ 5. ì‚¬ìš© ì˜ˆì‹œ ë° í…ŒìŠ¤íŠ¸ ì½”ë“œ

### 5.1 ê¸°ë³¸ ì‚¬ìš© ì˜ˆì‹œ
```python
# 1. ê³„ì‚°ê¸° ì´ˆê¸°í™”
calculator = WarehouseIOCalculator()
reporter = HVDCExcelReporterFinal()

# 2. ë°ì´í„° ë¡œë“œ
df = calculator.load_real_hvdc_data()

# 3. ê°ì¢… ê³„ì‚° ìˆ˜í–‰
inbound_result = calculator.calculate_warehouse_inbound(df)
outbound_result = calculator.calculate_warehouse_outbound(df)
inventory_result = calculator.calculate_warehouse_inventory(df)

# 4. ê²°ê³¼ í™•ì¸
print(f"ì´ ì…ê³ : {inbound_result['total_inbound']}ê±´")
print(f"ì´ ì¶œê³ : {outbound_result['total_outbound']}ê±´")
print(f"ì´ ì¬ê³ : {inventory_result['total_inventory']}ê±´")

# 5. Excel ì‹œíŠ¸ ìƒì„±
stats = {
    'inbound_result': inbound_result,
    'outbound_result': outbound_result,
    'inventory_result': inventory_result
}

warehouse_sheet = reporter.create_warehouse_monthly_sheet(stats)
site_sheet = reporter.create_site_monthly_sheet(stats)

# 6. Multi-Level Header ì ìš©
warehouse_sheet = reporter.create_multi_level_headers(warehouse_sheet, 'warehouse')
site_sheet = reporter.create_multi_level_headers(site_sheet, 'site')
```

### 5.2 KPI ê²€ì¦ ì˜ˆì‹œ
```python
# KPI ê²€ì¦ ìˆ˜í–‰
stats = {
    'processed_data': df,
    'inbound_result': inbound_result,
    'outbound_result': outbound_result,
    'inventory_result': inventory_result
}

validation_results = validate_kpi_thresholds(stats)

# ê²€ì¦ ê²°ê³¼ ì¶œë ¥
for kpi_name, result in validation_results.items():
    status = "âœ… PASS" if result['status'] == 'PASS' else "âŒ FAIL"
    print(f"{kpi_name}: {status} - {result['value']} (ì„ê³„ê°’: {result['threshold']})")
```

### 5.3 ìµœì¢… ê³„ì‚° í•¨ìˆ˜ ì‚¬ìš© ì˜ˆì‹œ
```python
# íŠ¹ì • ìœ„ì¹˜, íŠ¹ì • ì›”ì˜ ì…ê³ /ì¶œê³ /ì¬ê³  ê³„ì‚°
location = 'DSV Al Markaz'
year_month = pd.Period('2024-01')
month_end = pd.Timestamp('2024-01-31')

inbound_count = calculate_inbound_final(df, location, year_month)
outbound_count = calculate_outbound_final(df, location, year_month)
inventory_count = calculate_inventory_final(df, location, month_end)

print(f"{location} - {year_month}:")
print(f"  ì…ê³ : {inbound_count}ê±´")
print(f"  ì¶œê³ : {outbound_count}ê±´")
print(f"  ì¬ê³ : {inventory_count}ê±´")
```

---

## ğŸ”§ ì¶”ì²œ ëª…ë ¹ì–´:

`/logi_master analyze_inventory` [ì „ì²´ ì¬ê³  ë¶„ì„ - í˜„ì¬ ìƒíƒœ í™•ì¸]
`/switch_mode LATTICE` [ì°½ê³  ìµœì í™” ëª¨ë“œ - ì…ì¶œê³  ë¡œì§ ê²€ì¦]
`/validate_data excel_reporter` [Excel ë¦¬í¬í„° ê²€ì¦ - í’ˆì§ˆ í™•ì¸]
`/automate test-pipeline` [ì „ì²´ í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ - ì‹œìŠ¤í…œ ê²€ì¦]