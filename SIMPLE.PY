#!/usr/bin/env python3
"""
HVDC í”„ë¡œì íŠ¸ ì •í™•í•œ ì¬ê³  ê³„ì‚° í•¨ìˆ˜
ì œê³µëœ ì •í™•í•œ ìˆ«ìë“¤ê³¼ ì¼ì¹˜í•˜ëŠ” ë¡œì§ êµ¬í˜„

ëª©í‘œ ê²°ê³¼:
HITACHI: 5,126ê°œ, Simense: 1,853ê°œ, Total: 6,979ê°œ
"""

import pandas as pd
import numpy as np
from typing import Dict, Any

class CorrectInventoryCalculator:
    """
    ì •í™•í•œ ì¬ê³  ê³„ì‚°ê¸°
    ë³µì¡í•œ ë‚ ì§œ ì¶”ì  ëŒ€ì‹  í˜„ì¬ ìƒíƒœ ê¸°ë°˜ ë‹¨ìˆœ ì§‘ê³„
    """
    
    def __init__(self):
        # ìœ„ì¹˜ ë§¤í•‘ ì •ì˜
        self.location_mappings = {
            'sites': ['AGI', 'DAS', 'MIR', 'SHU'],
            'warehouses': [
                'DSV Indoor', 'DSV Outdoor', 'DSV Al Markaz', 'DSV MZP',
                'MOSB', 'AAA Storage', 'Hauler Indoor', 'DHL Warehouse'
            ],
            'special': ['Pre Arrival']
        }
        
        # ë²¤ë” ë§¤í•‘ ì •ì˜ (ì •í™•í•œ ë¶„ë¥˜ë¥¼ ìœ„í•´)
        self.vendor_mappings = {
            'HITACHI': ['HITACHI', 'HE', 'Hitachi'],
            'SIMENSE': ['SIMENSE', 'SIM', 'Siemens', 'SIEMENS']
        }
    
    def calculate_current_inventory_snapshot(self, df: pd.DataFrame) -> Dict[str, Any]:
        """
        í˜„ì¬ ì‹œì  ê¸°ì¤€ ì •í™•í•œ ì¬ê³  ê³„ì‚°
        
        í•µì‹¬ ì›ë¦¬:
        1. ê° ì•„ì´í…œì˜ í˜„ì¬ ìœ„ì¹˜ë§Œ ì¤‘ìš”í•¨
        2. ë²¤ë”ë³„ ì •í™•í•œ ë¶„ë¥˜
        3. ë‹¨ìˆœ ì¹´ìš´íŠ¸ (ë‚ ì§œ ë¬´ê´€)
        
        Args:
            df: HVDC ë°ì´í„°í”„ë ˆì„
            
        Returns:
            ìœ„ì¹˜ë³„/ë²¤ë”ë³„ ì¬ê³  í˜„í™© ë”•ì…”ë„ˆë¦¬
        """
        
        # Step 1: ë°ì´í„° ì •ì œ ë° ì¤€ë¹„
        df_clean = self._prepare_data(df)
        
        # Step 2: í˜„ì¬ ìœ„ì¹˜ ì •í™•íˆ ê³„ì‚°
        df_clean = self._calculate_current_location(df_clean)
        
        # Step 3: ë²¤ë” ì •í™•íˆ ë¶„ë¥˜
        df_clean = self._classify_vendor_correctly(df_clean)
        
        # Step 4: ìœ„ì¹˜ë³„/ë²¤ë”ë³„ ì§‘ê³„
        inventory_result = self._aggregate_by_location_vendor(df_clean)
        
        return inventory_result
    
    def _prepare_data(self, df: pd.DataFrame) -> pd.DataFrame:
        """
        ë°ì´í„° ì •ì œ ë° ì¤€ë¹„ (ì˜¨í†¨ë¡œì§€ ë§¤í•‘ ê¸°ì¤€ ì ìš©)
        """
        df_clean = df.copy()

        # 1. Vendor ì»¬ëŸ¼ ìƒì„±: 'HVDC CODE 3' â†’ vendor_mappings ì ìš©
        vendor_map = {
            'HE': 'HITACHI', 'HITACHI': 'HITACHI',
            'SIM': 'SIMENSE', 'SIMENSE': 'SIMENSE', 'SIEMENS': 'SIMENSE',
            'SCT': 'SAMSUNG', 'SAMSUNG': 'SAMSUNG',
            'ZEN': 'ZENER', 'ZENER': 'ZENER', 'ETC': 'ETC'
        }
        if 'HVDC CODE 3' in df_clean.columns:
            df_clean['Vendor'] = df_clean['HVDC CODE 3'].map(lambda x: vendor_map.get(str(x).strip().upper(), 'Other'))
        else:
            df_clean['Vendor'] = 'Unknown'

        # 2. Location ì»¬ëŸ¼ ìƒì„±: ì—¬ëŸ¬ ìœ„ì¹˜ ì»¬ëŸ¼ ì¤‘ ê°€ì¥ ìµœê·¼ ë‚ ì§œê°€ ìˆëŠ” ì»¬ëŸ¼ëª…
        location_candidates = [
            'DSV Indoor', 'DSV Outdoor', 'DSV Al Markaz', 'DSV MZP',
            'MOSB', 'AAA  Storage', 'Hauler Indoor'
        ]
        def find_latest_location(row):
            latest_date = None
            latest_loc = 'Unknown'
            for loc in location_candidates:
                if loc in row and pd.notna(row[loc]):
                    try:
                        d = pd.to_datetime(row[loc], errors='coerce')
                        if pd.notna(d) and (latest_date is None or d > latest_date):
                            latest_date = d
                            latest_loc = loc
                    except Exception:
                        continue
            return latest_loc
        df_clean['Location'] = df_clean.apply(find_latest_location, axis=1)

        # 3. í•„ìˆ˜ ì»¬ëŸ¼ ê¸°ë³¸ê°’ ë³´ì™„
        required_cols = ['Case No.', 'Vendor', 'Location']
        for col in required_cols:
            if col not in df_clean.columns:
                print(f"ê²½ê³ : {col} ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.")
                if col == 'Case No.':
                    df_clean[col] = df_clean.index.astype(str)
                elif col == 'Vendor':
                    df_clean[col] = 'Unknown'
                elif col == 'Location':
                    df_clean[col] = 'Unknown'

        return df_clean
    
    def _calculate_current_location(self, df: pd.DataFrame) -> pd.DataFrame:
        """
        í˜„ì¬ ìœ„ì¹˜ ì •í™•íˆ ê³„ì‚°
        
        ìš°ì„ ìˆœìœ„ ë¡œì§:
        1. Status_Locationì´ ëª…í™•í•˜ë©´ ê·¸ê²ƒ ì‚¬ìš©
        2. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìµœì‹  ë‚ ì§œ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê²°ì •
        3. Pre Arrival ìƒíƒœ ì •í™•íˆ ì‹ë³„
        """
        
        def determine_current_location(row):
            # 1. Status_Locationì´ ìœ íš¨í•œ ê²½ìš°
            if pd.notna(row.get('Status_Location')) and row['Status_Location'] != 'Unknown':
                return row['Status_Location']
            
            # 2. Status_Currentê°€ 'Pre Arrival'ì¸ ê²½ìš°
            if row.get('Status_Current') == 'Pre Arrival' or row.get('Status_Current') == 'pre_arrival':
                return 'Pre Arrival'
            
            # 3. ë‚ ì§œ ì»¬ëŸ¼ë“¤ ì¤‘ ê°€ì¥ ìµœì‹  ìœ„ì¹˜ ì°¾ê¸°
            latest_date = None
            latest_location = 'Unknown'
            
            # ëª¨ë“  ìœ„ì¹˜ ì»¬ëŸ¼ ì²´í¬
            all_locations = (self.location_mappings['sites'] + 
                           self.location_mappings['warehouses'])
            
            for location in all_locations:
                if location in row.index and pd.notna(row[location]):
                    try:
                        location_date = pd.to_datetime(row[location])
                        if latest_date is None or location_date > latest_date:
                            latest_date = location_date
                            latest_location = location
                    except:
                        continue
            
            return latest_location if latest_location != 'Unknown' else 'DSV Indoor'
        
        # í˜„ì¬ ìœ„ì¹˜ ê³„ì‚° ì ìš©
        df['Current_Location'] = df.apply(determine_current_location, axis=1)
        
        return df
    
    def _classify_vendor_correctly(self, df: pd.DataFrame) -> pd.DataFrame:
        """
        ë²¤ë” ì •í™•íˆ ë¶„ë¥˜
        """
        
        def classify_vendor(vendor_str):
            if pd.isna(vendor_str):
                return 'Unknown'
            
            vendor_upper = str(vendor_str).upper().strip()
            
            # HITACHI ê³„ì—´ í™•ì¸
            for hitachi_variant in self.vendor_mappings['HITACHI']:
                if hitachi_variant.upper() in vendor_upper:
                    return 'HITACHI'
            
            # SIMENSE ê³„ì—´ í™•ì¸
            for simense_variant in self.vendor_mappings['SIMENSE']:
                if simense_variant.upper() in vendor_upper:
                    return 'SIMENSE'
            
            return 'Other'
        
        df['Vendor_Clean'] = df['Vendor'].apply(classify_vendor)
        
        return df
    
    def _aggregate_by_location_vendor(self, df: pd.DataFrame) -> Dict[str, Any]:
        """
        ìœ„ì¹˜ë³„/ë²¤ë”ë³„ ì§‘ê³„
        """
        
        # ê¸°ë³¸ ì§‘ê³„
        location_vendor_counts = df.groupby(['Current_Location', 'Vendor_Clean']).size().unstack(fill_value=0)
        
        # ê²°ê³¼ êµ¬ì¡°í™”
        result = {
            'by_location_vendor': {},
            'totals_by_vendor': {},
            'totals_by_location': {},
            'grand_total': len(df)
        }
        
        # ëª¨ë“  ë²¤ë” íƒ€ì… ìˆ˜ì§‘ (HITACHI, SIMENSE, Unknown, Other ë“±)
        all_vendors = set()
        if not location_vendor_counts.empty:
            all_vendors = set(location_vendor_counts.columns)
        
        # ê¸°ë³¸ ë²¤ë”ë“¤ ì¶”ê°€
        all_vendors.update(['HITACHI', 'SIMENSE', 'Unknown', 'Other'])
        
        # ìœ„ì¹˜ë³„/ë²¤ë”ë³„ ìƒì„¸ ì§‘ê³„
        for location in location_vendor_counts.index:
            result['by_location_vendor'][location] = {}
            
            # ëª¨ë“  ë²¤ë”ì— ëŒ€í•´ ì¹´ìš´íŠ¸ ì„¤ì •
            for vendor in all_vendors:
                if vendor in location_vendor_counts.columns:
                    result['by_location_vendor'][location][vendor] = int(location_vendor_counts.loc[location, vendor])
                else:
                    result['by_location_vendor'][location][vendor] = 0
                
            # ìœ„ì¹˜ë³„ ì´í•© (HITACHI + SIMENSEë§Œ)
            result['totals_by_location'][location] = (
                result['by_location_vendor'][location].get('HITACHI', 0) + 
                result['by_location_vendor'][location].get('SIMENSE', 0)
            )
        
        # ë²¤ë”ë³„ ì´í•©
        for vendor in all_vendors:
            if vendor in location_vendor_counts.columns:
                result['totals_by_vendor'][vendor] = int(location_vendor_counts[vendor].sum())
            else:
                result['totals_by_vendor'][vendor] = 0
        
        return result
    
    def print_inventory_report(self, result: Dict[str, Any]):
        """
        ì¬ê³  í˜„í™© ë¦¬í¬íŠ¸ ì¶œë ¥ (ì œê³µëœ í˜•ì‹ê³¼ ë™ì¼)
        """
        print("\n" + "="*60)
        print("ğŸ“Š HVDC í”„ë¡œì íŠ¸ í˜„ì¬ ì¬ê³  í˜„í™©")
        print("="*60)
        print(f"{'ìœ„ì¹˜':<20} {'HITACHI':<10} {'Simense':<10} {'Total':<10}")
        print("-"*60)
        
        # ê° ìœ„ì¹˜ë³„ ì¶œë ¥
        for location, counts in result['by_location_vendor'].items():
            hitachi_count = counts['HITACHI']
            simense_count = counts['SIMENSE'] 
            total_count = hitachi_count + simense_count
            
            print(f"{location:<20} {hitachi_count:<10} {simense_count:<10} {total_count:<10}")
        
        print("-"*60)
        print(f"{'ì´í•©':<20} {result['totals_by_vendor']['HITACHI']:<10} {result['totals_by_vendor']['SIMENSE']:<10} {result['grand_total']:<10}")
        print("="*60)
    
    def validate_against_target(self, result: Dict[str, Any]) -> Dict[str, bool]:
        """
        ì œê³µëœ ëª©í‘œ ìˆ«ìì™€ ë¹„êµ ê²€ì¦
        """
        target_totals = {
            'HITACHI': 5126,
            'SIMENSE': 1853,
            'Total': 6979
        }
        
        validation = {
            'hitachi_match': result['totals_by_vendor']['HITACHI'] == target_totals['HITACHI'],
            'simense_match': result['totals_by_vendor']['SIMENSE'] == target_totals['SIMENSE'],
            'total_match': result['grand_total'] == target_totals['Total']
        }
        
        print(f"\nğŸ” ëª©í‘œ ìˆ«ìì™€ ë¹„êµ ê²€ì¦:")
        print(f"HITACHI: {result['totals_by_vendor']['HITACHI']} vs {target_totals['HITACHI']} {'âœ…' if validation['hitachi_match'] else 'âŒ'}")
        print(f"SIMENSE: {result['totals_by_vendor']['SIMENSE']} vs {target_totals['SIMENSE']} {'âœ…' if validation['simense_match'] else 'âŒ'}")
        print(f"Total: {result['grand_total']} vs {target_totals['Total']} {'âœ…' if validation['total_match'] else 'âŒ'}")
        
        return validation


# ì‚¬ìš© ì˜ˆì‹œ
def run_correct_inventory_calculation(excel_file_path: str):
    """
    ì •í™•í•œ ì¬ê³  ê³„ì‚° ì‹¤í–‰
    """
    
    # ë°ì´í„° ë¡œë“œ
    df = pd.read_excel(excel_file_path)
    
    # ì •í™•í•œ ì¬ê³  ê³„ì‚°ê¸° ì´ˆê¸°í™”
    calculator = CorrectInventoryCalculator()
    
    # í˜„ì¬ ì¬ê³  í˜„í™© ê³„ì‚°
    result = calculator.calculate_current_inventory_snapshot(df)
    
    # ê²°ê³¼ ì¶œë ¥
    calculator.print_inventory_report(result)
    
    # ëª©í‘œ ìˆ«ìì™€ ê²€ì¦
    validation = calculator.validate_against_target(result)
    
    return result, validation


if __name__ == "__main__":
    # ì‹¤í–‰ ì˜ˆì‹œ - ë²¤ë”ë³„ íŒŒì¼ í†µí•© ì²˜ë¦¬
    hitachi_file = "data/HVDC WAREHOUSE_HITACHI(HE).xlsx"
    simense_file = "data/HVDC WAREHOUSE_SIMENSE(SIM).xlsx"
    
    # ë²¤ë”ë³„ íŒŒì¼ ë¡œë“œ ë° í†µí•©
    try:
        df_hitachi = pd.read_excel(hitachi_file)
        df_hitachi['Vendor'] = 'HITACHI'  # ëª…ì‹œì  ë²¤ë” ì§€ì •
        print(f"âœ… HITACHI íŒŒì¼ ë¡œë“œ: {len(df_hitachi)}ê±´")
    except Exception as e:
        print(f"âŒ HITACHI íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
        df_hitachi = pd.DataFrame()
    
    try:
        df_simense = pd.read_excel(simense_file)
        df_simense['Vendor'] = 'SIMENSE'  # ëª…ì‹œì  ë²¤ë” ì§€ì •
        print(f"âœ… SIMENSE íŒŒì¼ ë¡œë“œ: {len(df_simense)}ê±´")
    except Exception as e:
        print(f"âŒ SIMENSE íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
        df_simense = pd.DataFrame()
    
    # ë°ì´í„° í†µí•©
    if not df_hitachi.empty and not df_simense.empty:
        df_combined = pd.concat([df_hitachi, df_simense], ignore_index=True)
        print(f"âœ… í†µí•© ë°ì´í„°: {len(df_combined)}ê±´")
        
        # ì •í™•í•œ ì¬ê³  ê³„ì‚°ê¸° ì´ˆê¸°í™”
        calculator = CorrectInventoryCalculator()
        
        # í˜„ì¬ ì¬ê³  í˜„í™© ê³„ì‚°
        result = calculator.calculate_current_inventory_snapshot(df_combined)
        
        # ê²°ê³¼ ì¶œë ¥
        calculator.print_inventory_report(result)
        
        # ëª©í‘œ ìˆ«ìì™€ ê²€ì¦
        validation = calculator.validate_against_target(result)
    else:
        print("âŒ ë°ì´í„° íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨ë¡œ ê³„ì‚°ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")